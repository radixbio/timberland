version: '3'
services:
  consul:
    image: "consul:1.7.2"
    hostname: "consul"
    command: "agent -dev -client=0.0.0.0 -advertise=\"{{ GetInterfaceIP \\\"ethwe0\\\" }}\""
#    network_mode: "host"
    ports:
      - "8500:8500"
      - "169.254.1.1:53:8600/udp"
      - "8502:8502"
      - "8300:8300"
      - "8301:8301"
    environment:
      - CONSUL_ALLOW_PRIVILEGED_PORTS=
    networks:
      - weave
  nomad:
    image: "bazel/timberland/jvm:nomad"
    hostname: "nomad"
    command: "agent -config=/opt/nomad.hcl"
    privileged: true
    ports:
      - "4646:4646"
      - "4647:4647"
      - "4648:4648"
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - ./nomad.hcl:/opt/nomad.hcl
    - /opt/radix/timberland:/opt/radix/timberland
    - /tmp/nomad:/tmp/nomad
    - /root/.docker/config.json:/root/config.json
    depends_on:
      - consul
    dns:
      - 169.254.1.1
      - 1.1.1.1
    networks:
      - weave

networks:
  weave:
    external: true
